#!/usr/bin/env php
<?php
/**
 * MoeFrame 框架的 maidchan 脚本工具
 * 用于启动开发服务器并处理路由
 * 
 * 使用方法:
 *   php maidchan run               - 在默认地址 0.0.0.0:8000 启动开发服务器
 *   php maidchan run -l 127.0.0.1  - 在指定地址 127.0.0.1:8000 启动开发服务器
 *   php maidchan run -p 8888       - 在默认地址 0.0.0.0:8888 启动开发服务器
 *   php maidchan run -l 127.0.0.1 -p 8888 - 在指定地址 127.0.0.1:8888 启动开发服务器
 */

// 检查是否在CLI模式下运行
if (php_sapi_name() !== 'cli') {
    die("This script must be run in CLI mode\n");
}

// 初始化MoeFrame框架（用于命令行环境）
function initializeMoeFrame() {
    // 定义根目录
    $rootDir = dirname(__FILE__);
    
    // 加载框架核心库
    foreach (glob($rootDir . "/lib/*.php") as $filename) {
        require_once $filename;
    }
    
    // 加载应用
    foreach (glob($rootDir . "/app/*.php") as $filename) {
        require_once $filename;
    }
    
    // 创建路由实例
    global $MoeRouter;
    $MoeRouter = new MoeRouter();
    
    // 加载路由配置
    require_once $rootDir . "/conf/route.inc.php";
}

// 解析命令行参数
function parseCommandLineArgs() {
    $shortopts = "l:p:";
    $longopts = ["listen:", "port:"];
    
    $options = getopt($shortopts, $longopts);
    
    // 默认参数
    $args = [
        'listen' => '0.0.0.0',
        'port' => 8000
    ];
    
    // 处理命令行参数
    if (isset($options['l'])) {
        $args['listen'] = $options['l'];
    } elseif (isset($options['listen'])) {
        $args['listen'] = $options['listen'];
    }
    
    if (isset($options['p'])) {
        $args['port'] = intval($options['p']);
    } elseif (isset($options['port'])) {
        $args['port'] = intval($options['port']);
    }
    
    return $args;
}

// 检查端口是否被占用
function checkPort($listen, $port) {
    $socket = @fsockopen($listen, $port, $errno, $errstr, 1);
    if ($socket) {
        fclose($socket);
        return false; // 端口已被占用
    }
    return true; // 端口可用
}

// 启动PHP内置服务器
function startPHPServer($listen, $port) {
    // 检查端口是否可用
    if (!checkPort($listen, $port)) {
        echo "Error: Port {$port} is already in use\n";
        exit(1);
    }
    
    // 获取项目根目录
    $rootDir = dirname(__FILE__);
    
    // 设置public目录为文档根目录
    $publicDir = $rootDir . '/public';
    
    echo "======================================================\n";
    echo "  MoeFrame Development Server (maidchan)\n";
    echo "======================================================\n";
    echo "  Starting server...\n";
    echo "  Listening on http://{$listen}:{$port}\n";
    echo "  Document root: {$publicDir}\n";
    echo "  Entry point: index.php\n";
    echo "  Press Ctrl+C to stop the server\n";
    echo "======================================================\n\n";
    
    // 启动PHP内置服务器，直接使用public/index.php作为入口点
    $command = "php -S {$listen}:{$port} -t {$publicDir}";
    
    echo "  Running command: {$command}\n\n";
    
    // 执行命令并保持运行
    passthru($command);
}

// 主函数
function main() {
    // 获取命令
    $argv = $_SERVER['argv'];
    
    if (count($argv) < 2) {
        echo "MoeFrame maidchan - Development Helper Tool\n";
        echo "\n";
        echo "Usage: php maidchan <command> [options]\n";
        echo "\n";
        echo "Available commands:\n";
        echo "  run    Start development server\n";
        echo "\n";
        echo "Options for run:\n";
        echo "  -l, --listen    Specify listen address (default: 0.0.0.0)\n";
        echo "  -p, --port      Specify listen port (default: 8000)\n";
        echo "\n";
        echo "Examples:\n";
        echo "  php maidchan run\n";
        echo "  php maidchan run -l 127.0.0.1\n";
        echo "  php maidchan run -p 8888\n";
        echo "  php maidchan run -l 127.0.0.1 -p 8888\n";
        exit(1);
    }
    
    $command = $argv[1];
    
    switch ($command) {
        case 'run':
            $args = parseCommandLineArgs();
            startPHPServer($args['listen'], $args['port']);
            break;
        default:
            echo "Unknown command: {$command}\n";
            echo "Type 'php maidchan' for usage information\n";
            exit(1);
    }
}

// 运行主函数
main();